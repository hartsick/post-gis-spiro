<div id="map-canvas">
</div>

<div id="controls">
  <button id="session-control">Start Tracking</button>
</div>

<script>
  // Display map
  var map;

  // Set map styles
  var styles = [
    {
      featureType: "all",
      elementType: "geometry",
      stylers: [
        { gamma: 1.6 },
        { lightness: -5 },
        { saturation: -100 }
      ]
    },
    {
      featureType: "road",
      elementType: "geometry",
      stylers: [
        { lightness: 100 },
        { visibility: "simplified" },
        { gamma: 10 }
      ]
    },  
    {
      featureType: "transit",
      elementType: "geometry",
      stylers: [
        { visibility: "simplified" },
        { gamma: 10 },
        { lightness: 100 }
      ]
    },      
    {
      featureType: "water",
      elementType: "geometry",
      stylers: [
        { lightness: -30 }
      ]
    },    
    {
      featureType: "all",
      elementType: "labels",
      stylers: [
        { visibility: "off" }
      ]
    }
  ];

  function initialize() {
    // set up map
    var mapOptions = {
      zoom: 15,
      center: {lat: 10, lng: 10},
      styles: styles
    };
    map = new google.maps.Map(document.getElementById('map-canvas'),
        mapOptions);
  }
  google.maps.event.addDomListener(window, 'load', initialize);


  // start monitoring location
  var watchID = false;
  var options = {    
    enableHighAccuracy: true,
    timeout: 5000,
    maximumAge: 0
  };
  var isReady = true;
  var markerCounter = 1;

  // Bind buttons
  $('#session-control').click(function(){
    // if watchID exists, 
    if (watchID){
      navigator.geolocation.clearWatch(watchID);
      console.log(watchID, "session ended.");  

      // reset watchID to false
      watchID = false;

      // update button text
      $(this).text("Start Tracking");
    }
    else {
      // start watching for movement
      watchID = navigator.geolocation.watchPosition(onSuccess, onError, options);
      console.log(watchID, "session started.");

      // update button text
      $(this).text("Stop Tracking");
    }
  });

  function onSuccess(position) {
    // only update every 30 seconds
    if (isReady){

      // reset timer
      isReady = false

      // create a new tracking point for user
      $.ajax({
          type: 'POST',
          url: '/user_locations',
          data: {
            lat: position.coords.latitude,
            lng: position.coords.longitude,
            accuracy: position.coords.accuracy,
            timestamp: position.timestamp,
            user_id: 2
          }
        });

      console.log("markerCounter:", markerCounter, "|", position.coords.latitude, position.coords.longitude);

      // prepare marker
      var markerLatlng = {lat: parseFloat(position.coords.latitude), lng: parseFloat(position.coords.longitude)};

      // var marker = new google.maps.Marker({
      //   position: markerLatlng
      // });

      // // place marker
      // marker.setMap(map);

      // center map
      map.setCenter(markerLatlng);

      // Construct the circle for each value in citymap.
      // Note: We scale the area of the circle based on the population.
      var circleOptions = {
        strokeColor: '#FF0000',
        strokeOpacity: 0.8,
        strokeWeight: 1,
        fillColor: '#FF0000',
        fillOpacity: 0.35,
        map: map,
        center: markerLatlng,
        radius: 30
      };
      // Add the circle for this city to the map.
      cityCircle = new google.maps.Circle(circleOptions);

      // increment marker counter
      markerCounter++;
      // }

      currentTime = new Date().getTime();
      console.log("Time:", currentTime, "|","Next running:",currentTime + 30000);

      // after 30 second pause, get ready to go again
      window.setTimeout(function(){
        isReady = true;
      }, 30000)
    }
  }

  function onError(error){
    console.log('code: ' + error.code +
      ' | message: ' + error.message
    );
  }
</script>